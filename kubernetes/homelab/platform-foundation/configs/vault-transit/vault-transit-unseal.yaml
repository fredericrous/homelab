apiVersion: vault.homelab.io/v1alpha1
kind: VaultTransitUnseal
metadata:
  name: vault-main
  namespace: vault
spec:
  vaultPod:
    namespace: vault
    selector:
      app.kubernetes.io/name: vault
      component: server
  transitVault:
    address: http://vault-vault-nas-ui.vault.svc.nas.local:8200
    secretRef:
      name: vault-transit-token
      key: token
    keyName: autounseal
    mountPath: transit
    tlsSkipVerify: true
  initialization:
    recoveryShares: 1
    recoveryThreshold: 1
    secretNames:
      adminToken: vault-admin-token
      recoveryKeys: vault-keys
      storeRecoveryKeys: true
      adminTokenAnnotations:
        reflector.v1.k8s.emberstack.com/reflection-allowed: "true"
        reflector.v1.k8s.emberstack.com/reflection-auto-enabled: "true"
  monitoring:
    checkInterval: 30s
    retryInterval: 10s

  postUnsealConfig:
    enableKV: true
    kvConfig:
      path: "secret"
      version: 2

    enableExternalSecretsOperator: true
    externalSecretsOperatorConfig:
      policyName: "external-secrets-operator"
      kubernetesAuth:
        roleName: "external-secrets-operator"
        serviceAccounts:
          - name: external-secrets
            namespace: external-secrets
          - name: external-secrets-operator
            namespace: external-secrets
          - name: external-secrets-external-secrets
            namespace: external-secrets
        ttl: "24h"
        maxTTL: "24h"
