apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: stremio

resources:
  - namespace.yaml
  - service-account.yaml
  - secret-store.yaml     # Namespace-scoped SecretStore
  - external-secrets.yaml
  - pvc.yaml
  - nginx-config.yaml
  - server-nginx-proxy-config.yaml
  - ffmpeg-mtls-config.yaml
  - mtls-client-config.yaml
  - deployment-server.yaml
  - deployment-web.yaml
  - service.yaml
  - peerauthentication.yaml
  - stremio-ca-secret.yaml
  - buildkit-job.yaml

patches:
  # Add backup annotations
  - target:
      kind: Deployment
      name: stremio-server
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: stremio-server
      spec:
        template:
          metadata:
            annotations:
              backup.velero.io/backup-volumes: config,media
