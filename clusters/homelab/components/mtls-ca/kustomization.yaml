apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

# This component automatically adds client CA certificate to TLS secrets for mTLS
patches:
  # Patch all TLS secrets to include client CA certificate
  - target:
      kind: Secret
      name: ".*-tls"
    patch: |
      - op: add
        path: /data/ca.crt
        value: $CLIENT_CA_CERT

# Use Kustomize replacements to substitute the actual CA certificate value
replacements:
  - source:
      kind: Secret
      name: client-ca-cert
      namespace: istio-system
      fieldPath: data.ca\.crt
    targets:
      - select:
          kind: Secret
          name: ".*-tls"
        fieldPaths:
          - data.ca\.crt