# Base policy for apps using External Secrets
apiVersion: redhatcop.redhat.io/v1alpha1
kind: Policy
metadata:
  name: external-secrets
  namespace: vault-config-operator
spec:
  authentication:
    path: kubernetes
    role: controller-manager
    serviceAccount:
      name: controller-manager
  policy: |
    # Allow apps to read their own secrets
    path "secret/data/{{identity.entity.aliases.auth_kubernetes_a0e7b119.metadata.service_account_namespace}}/*" {
      capabilities = ["read", "list"]
    }
    
    # Allow apps to push secrets to their namespace path
    path "secret/data/{{identity.entity.aliases.auth_kubernetes_a0e7b119.metadata.service_account_namespace}}/*" {
      capabilities = ["create", "update", "patch", "delete"]
    }
    
    # Allow metadata operations for their namespace
    path "secret/metadata/{{identity.entity.aliases.auth_kubernetes_a0e7b119.metadata.service_account_namespace}}/*" {
      capabilities = ["read", "list", "create", "update", "delete"]
    }
    
    # Allow reading shared secrets
    path "secret/data/shared/*" {
      capabilities = ["read", "list"]
    }
    
    # Allow reading PKI secrets
    path "secret/data/pki/*" {
      capabilities = ["read", "list"]
    }
    
    # Allow reading NFS credentials
    path "secret/data/nfs" {
      capabilities = ["read"]
    }
    
    # Auth token lookup (required for self-service)
    path "auth/token/lookup-self" {
      capabilities = ["read"]
    }
  type: acl