---
apiVersion: batch/v1
kind: Job
metadata:
  name: lldap-create-openwebui-service-account
  namespace: openwebui
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      serviceAccountName: openwebui
      restartPolicy: OnFailure
      containers:
      - name: create-service-account
        image: alpine/curl:latest
        command:
        - /bin/sh
        - -c
        - |
          set -e
          
          echo "Creating Open WebUI service account in LLDAP..."
          
          # Get LLDAP admin credentials
          LLDAP_ADMIN_USERNAME="admin"
          LLDAP_ADMIN_PASSWORD=$(cat /var/secrets/lldap/ldap_user_pass)
          
          # LLDAP API endpoint
          LLDAP_API_URL="http://lldap.lldap.svc.cluster.local:17170"
          
          echo "Getting JWT token from LLDAP..."
          
          # Login to LLDAP to get JWT token
          JWT_TOKEN=$(curl -s -X POST "$LLDAP_API_URL/auth/simple/login" \
            -H "Content-Type: application/json" \
            -d "{\"username\":\"$LLDAP_ADMIN_USERNAME\",\"password\":\"$LLDAP_ADMIN_PASSWORD\"}" \
            | grep -o '"token":"[^"]*"' | cut -d'"' -f4)
          
          if [ -z "$JWT_TOKEN" ]; then
            echo "Failed to get JWT token from LLDAP"
            exit 1
          fi
          
          echo "Successfully obtained JWT token"
          
          # Check if openwebui-service user already exists
          echo "Checking if openwebui-service user already exists..."
          
          EXISTING_USER=$(curl -s -X POST "$LLDAP_API_URL/api/graphql" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $JWT_TOKEN" \
            -d '{"query":"query { users(filters: {userId: {eq: \"openwebui-service\"}}) { id userId displayName email } }"}' \
            | grep -o '"users":\[[^]]*\]')
          
          if echo "$EXISTING_USER" | grep -q "openwebui-service"; then
            echo "✅ User openwebui-service already exists"
            exit 0
          fi
          
          echo "Creating openwebui-service user..."
          
          # Generate a strong password
          SERVICE_ACCOUNT_PASSWORD=$(openssl rand -base64 32 | tr -d "=+/")
          
          # Create the service account user
          CREATE_RESPONSE=$(curl -s -X POST "$LLDAP_API_URL/api/graphql" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $JWT_TOKEN" \
            -d '{
              "query": "mutation CreateUser($user: CreateUserInput!) { createUser(user: $user) { id userId } }",
              "variables": {
                "user": {
                  "userId": "openwebui-service",
                  "displayName": "Open WebUI Service Account",
                  "firstName": "OpenWebUI",
                  "lastName": "Service",
                  "email": "openwebui-service@daddyshome.fr"
                }
              }
            }')
          
          echo "Create user response: $CREATE_RESPONSE"
          
          # Check if user creation was successful
          if echo "$CREATE_RESPONSE" | grep -q '"createUser"'; then
            echo "✅ Successfully created openwebui-service user"
          else
            echo "❌ Failed to create openwebui-service user"
            echo "Response: $CREATE_RESPONSE"
            exit 1
          fi
          
          # Set password for the service account
          echo "Setting password for openwebui-service user..."
          
          PASSWORD_RESPONSE=$(curl -s -X POST "$LLDAP_API_URL/api/graphql" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $JWT_TOKEN" \
            -d "{
              \"query\": \"mutation UpdateUserPassword(\$userId: String!, \$password: String!) { updateUserPassword(userId: \$userId, password: \$password) { ok } }\",
              \"variables\": {
                \"userId\": \"openwebui-service\",
                \"password\": \"$SERVICE_ACCOUNT_PASSWORD\"
              }
            }")
          
          echo "Password update response: $PASSWORD_RESPONSE"
          
          if echo "$PASSWORD_RESPONSE" | grep -q '"ok":true'; then
            echo "✅ Successfully set password for openwebui-service user"
          else
            echo "❌ Failed to set password for openwebui-service user"
            exit 1
          fi
          
          # Add user to lldap_strict_readonly group for read-only access
          echo "Adding openwebui-service to lldap_strict_readonly group..."
          
          GROUP_RESPONSE=$(curl -s -X POST "$LLDAP_API_URL/api/graphql" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $JWT_TOKEN" \
            -d '{
              "query": "mutation AddUserToGroup($userId: String!, $groupId: Int!) { addUserToGroup(userId: $userId, groupId: $groupId) { ok } }",
              "variables": {
                "userId": "openwebui-service",
                "groupId": 2
              }
            }')
          
          echo "Group assignment response: $GROUP_RESPONSE"
          
          if echo "$GROUP_RESPONSE" | grep -q '"ok":true'; then
            echo "✅ Successfully added openwebui-service to lldap_strict_readonly group"
          else
            echo "⚠️  Failed to add to readonly group, but user creation successful"
          fi
          
          echo "✅ Open WebUI service account created successfully!"
          echo "Username: openwebui-service"
          echo "DN: uid=openwebui-service,ou=people,dc=daddyshome,dc=fr"
          echo "Email: openwebui-service@daddyshome.fr"
          echo "Password stored securely (not logged)"
          
        volumeMounts:
        - name: lldap-secrets
          mountPath: /var/secrets/lldap
          readOnly: true
      volumes:
      - name: lldap-secrets
        secret:
          secretName: lldap-secrets