---
# Password generators for MinIO credentials
apiVersion: generators.external-secrets.io/v1alpha1
kind: Password
metadata:
  name: minio-username
  namespace: minio
spec:
  length: 16
  digits: 4
  symbols: 0
  symbolCharacters: ""
  noUpper: false
  allowRepeat: true
---
apiVersion: generators.external-secrets.io/v1alpha1
kind: Password
metadata:
  name: minio-password
  namespace: minio
spec:
  length: 32
  digits: 8
  symbols: 8
  symbolCharacters: "!@#$%^&*"
  noUpper: false
  allowRepeat: true
---
# Generate random MinIO credentials using external-secrets password generator
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: minio-credentials-generator
  namespace: minio
spec:
  refreshInterval: 24h  # Only generate once per day if secret doesn't exist
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: minio-generated-credentials
    creationPolicy: Owner
  dataFrom:
  - sourceRef:
      generatorRef:
        apiVersion: generators.external-secrets.io/v1alpha1
        kind: Password
        name: minio-username
    rewrite:
    - regexp:
        source: "(.*)"
        target: "root-user"
  - sourceRef:
      generatorRef:
        apiVersion: generators.external-secrets.io/v1alpha1
        kind: Password
        name: minio-password
    rewrite:
    - regexp:
        source: "(.*)"
        target: "root-password"
---
# Push the generated MinIO credentials to Vault for other services to use
apiVersion: external-secrets.io/v1alpha1
kind: PushSecret
metadata:
  name: minio-credentials-to-vault
  namespace: minio
spec:
  refreshInterval: 1h
  secretStoreRefs:
  - name: vault-backend
    kind: ClusterSecretStore
  selector:
    secret:
      name: minio-generated-credentials
  data:
  - match:
      secretKey: root-user
      remoteRef:
        remoteKey: data/minio
        property: root-user
  - match:
      secretKey: root-password
      remoteRef:
        remoteKey: data/minio
        property: root-password