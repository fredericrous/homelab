apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: harbor

resources:
  - namespace.yaml
  - service-account.yaml
  - secret-store.yaml               # Namespace-scoped SecretStore with Harbor policy
  - password-generators.yaml         # Password generators
  - external-secrets-generated.yaml  # Generated secrets
  - harbor-db-credentials.yaml      # Database credentials for CloudNativePG
  - harbor-database.yaml            # Harbor main database
  - push-secrets.yaml               # Push generated secrets to Vault
  - external-secrets.yaml           # Pull from Vault (after push)
  - harbor-keys-init-job.yaml       # Initialize Harbor core keys in Vault
  - harbor-core-secret-generator.yaml # Generate harbor-core-secret from Vault
  - deployments/                    # Harbor deployment manifests

# Override namespace for Database resources to be in postgres
patchesJson6902:
- target:
    version: v1
    group: postgresql.cnpg.io
    kind: Database
    name: harbor
  patch: |-
    - op: replace
      path: /metadata/namespace
      value: postgres
