---
apiVersion: batch/v1
kind: Job
metadata:
  name: vault-oidc-config
  namespace: vault-config-operator
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      serviceAccountName: vault-config-operator
      restartPolicy: OnFailure
      containers:
      - name: vault-config
        image: hashicorp/vault:1.15.2
        command:
        - /bin/sh
        - -c
        - |
          set -e

          echo "Configuring Vault OIDC authentication..."

          # Set Vault connection
          export VAULT_ADDR=http://vault-vault.vault.svc.cluster.local:8200
          export VAULT_TOKEN=$(cat /var/secrets/vault-admin-token/token)

          echo "Enabling JWT/OIDC auth method..."

          # Enable OIDC auth method if not already enabled
          if ! vault auth list | grep -q oidc; then
            vault auth enable -path=oidc jwt
            echo "✅ OIDC auth method enabled"
          else
            echo "✅ OIDC auth method already enabled"
          fi

          echo "Configuring OIDC provider (Authelia)..."

          # Configure OIDC provider
          vault write auth/oidc/config \
            oidc_discovery_url="https://authx.daddyshome.fr" \
            oidc_client_id="vault" \
            oidc_client_secret="$(cat /var/secrets/vault-oidc/client_secret)" \
            default_role="admin"

          echo "✅ OIDC provider configured"

          echo "Creating admin role..."

          # Create admin role for Vault OIDC
          vault write auth/oidc/role/admin \
            allowed_redirect_uris="https://vaultx.daddyshome.fr/ui/vault/auth/oidc/oidc/callback,https://vaultx.daddyshome.fr/oidc/callback" \
            user_claim="preferred_username" \
            groups_claim="groups" \
            oidc_scopes="openid,profile,groups,email" \
            policies="admin" \
            ttl="8h" \
            max_ttl="24h"

          echo "✅ Admin role created"

          echo "Creating user role..."

          # Create user role for regular users
          vault write auth/oidc/role/user \
            allowed_redirect_uris="https://vaultx.daddyshome.fr/ui/vault/auth/oidc/oidc/callback,https://vaultx.daddyshome.fr/oidc/callback" \
            user_claim="preferred_username" \
            groups_claim="groups" \
            oidc_scopes="openid,profile,groups,email" \
            policies="default" \
            ttl="2h" \
            max_ttl="8h"

          echo "✅ User role created"

          echo "OIDC authentication configured successfully!"

        volumeMounts:
        - name: vault-admin-token
          mountPath: /var/secrets/vault-admin-token
          readOnly: true
        - name: vault-oidc-secret
          mountPath: /var/secrets/vault-oidc
          readOnly: true
      volumes:
      - name: vault-admin-token
        secret:
          secretName: vault-admin-token
      - name: vault-oidc-secret
        secret:
          secretName: vault-oidc-secret
