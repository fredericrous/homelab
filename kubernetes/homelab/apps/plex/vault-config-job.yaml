---
apiVersion: batch/v1
kind: Job
metadata:
  name: plex-vault-setup
  namespace: plex
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      serviceAccountName: plex
      volumes:
      - name: vault-admin-token
        secret:
          secretName: vault-admin-token
      containers:
      - name: vault
        image: hashicorp/vault:1.16
        env:
        - name: VAULT_ADDR
          value: "http://vault-vault.vault.svc.cluster.local:8200"
        - name: X_PLEX_TOKEN
          valueFrom:
            secretKeyRef:
              name: cluster-vars
              key: X_PLEX_TOKEN
        volumeMounts:
        - name: vault-admin-token
          mountPath: /vault/token
        command:
        - /bin/sh
        - -c
        - |
          export VAULT_TOKEN=$(cat /vault/token/token)
          
          # Create Plex account config in Vault (X_PLEX_TOKEN)
          vault kv put secret/plex/account \
            X_PLEX_TOKEN="$X_PLEX_TOKEN"
          
          # Create Plex config in Vault
          vault kv put secret/plex/config \
            timezone="Europe/Paris"
          
          echo "âœ… Plex secrets configured in Vault"