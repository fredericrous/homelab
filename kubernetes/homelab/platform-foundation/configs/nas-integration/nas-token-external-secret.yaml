---
apiVersion: external-secrets.io/v1
kind: SecretStore
metadata:
  name: nas-vault-store
  namespace: nas-integration
spec:
  provider:
    vault:
      server: "http://192.168.1.42:61200"
      path: "secret"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "nas-external-secrets"
          serviceAccountRef:
            name: nas-external-secrets
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: nas-vault-token
  namespace: nas-integration
  annotations:
    homelab.io/description: "NAS Vault root token for main cluster operations"
spec:
  refreshInterval: 5m  # Refresh every 5 minutes
  secretStoreRef:
    name: nas-vault-store
    kind: SecretStore
  target:
    name: nas-vault-token
    creationPolicy: Owner
    template:
      metadata:
        annotations:
          homelab.io/source: "nas-vault"
          homelab.io/last-refresh: "{{ now | date \"2006-01-02T15:04:05Z07:00\" }}"
        labels:
          homelab.io/component: "nas-integration"
      data:
        # Store token in multiple formats for different consumers
        token: "{{ .token }}"
        QNAP_VAULT_TOKEN: "{{ .token }}"
        # Token metadata for monitoring
        token-hint: "{{ .token | toString | trunc 8 }}****(refreshed)"
        expires-at: "{{ now | dateModify \"+24h\" | date \"2006-01-02T15:04:05Z07:00\" }}"
  data:
  - secretKey: token
    remoteRef:
      key: tokens/root  # Path in NAS Vault where current token is stored
      property: token
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: nas-external-secrets
  namespace: nas-integration
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: nas-external-secrets
  namespace: nas-integration
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: nas-external-secrets
  namespace: nas-integration
subjects:
- kind: ServiceAccount
  name: nas-external-secrets
  namespace: nas-integration
roleRef:
  kind: Role
  name: nas-external-secrets
  apiGroup: rbac.authorization.k8s.io