apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: harbor

resources:
  - namespace.yaml
  - service-account.yaml
  - secret-store.yaml               # Namespace-scoped SecretStore with Harbor policy
  - password-generators.yaml         # Password generators
  - external-secrets-generated.yaml  # Generated secrets
  - harbor-db-credentials.yaml      # Database credentials for CloudNativePG
  - push-secrets.yaml               # Push generated secrets to Vault
  - external-secrets.yaml           # Pull from Vault (after push)
  - harbor-helmrepository.yaml      # Harbor Helm repository (namespace override)
  - harbor-helmrelease.yaml
  # Manual mTLS configuration replaced by Kyverno ingress-mtls-automation policy
  # Resources automatically generated when service has annotation: istio.io/ingress-mtls: "true"

# Override namespace for HelmRepository to be in flux-system
patchesJson6902:
- target:
    version: v1beta2
    group: source.toolkit.fluxcd.io
    kind: HelmRepository
    name: harbor
  patch: |-
    - op: replace
      path: /metadata/namespace
      value: flux-system
