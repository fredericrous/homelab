---
apiVersion: batch/v1
kind: Job
metadata:
  name: stalwart-vault-setup
  namespace: stalwart
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      serviceAccountName: stalwart
      volumes:
      - name: vault-admin-token
        secret:
          secretName: vault-admin-token
      - name: generated-password
        secret:
          secretName: stalwart-admin-password
      containers:
      - name: vault
        image: hashicorp/vault:1.16
        env:
        - name: VAULT_ADDR
          value: "http://vault-vault.vault.svc.cluster.local:8200"
        volumeMounts:
        - name: vault-admin-token
          mountPath: /vault/token
        - name: generated-password
          mountPath: /passwords
        command:
        - /bin/sh
        - -c
        - |
          export VAULT_TOKEN=$(cat /vault/token/token)
          
          # Check if secrets already exist
          if vault kv get secret/stalwart >/dev/null 2>&1; then
            echo "✅ Stalwart secrets already exist in Vault"
            exit 0
          fi
          
          # Get generated admin password
          ADMIN_PASSWORD=$(cat /passwords/password)
          
          # Create Stalwart admin credentials in Vault
          vault kv put secret/stalwart \
            admin-password="$ADMIN_PASSWORD" \
            admin-username="admin" \
            domain="daddyshome.fr"
          
          echo "✅ Stalwart secrets configured in Vault"
          echo "Admin password: $ADMIN_PASSWORD"