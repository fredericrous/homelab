# Job to create vault-admin policy and kubernetes auth role in Vault
# This is necessary because vault-config-operator resources have authentication
# blocks added by mutating webhooks that conflict with token auth
apiVersion: batch/v1
kind: Job
metadata:
  name: vault-admin-setup
  namespace: vault-config-operator
spec:
  template:
    spec:
      serviceAccountName: vault-config-operator
      restartPolicy: OnFailure
      containers:
      - name: setup
        image: hashicorp/vault:1.15.0
        env:
        - name: VAULT_ADDR
          value: http://vault-vault.vault.svc.cluster.local:8200
        - name: VAULT_TOKEN
          valueFrom:
            secretKeyRef:
              name: vault-admin-token
              key: token
        command:
        - sh
        - -c
        - |
          # Wait for Vault to be ready
          until vault status; do
            echo "Waiting for Vault to be ready..."
            sleep 5
          done

          # Create vault-admin policy if it doesn't exist
          echo "Creating vault-admin policy..."
          vault policy write vault-admin - <<EOF
          # Admin access to all paths
          path "*" {
            capabilities = ["create", "read", "update", "delete", "list", "sudo"]
          }
          EOF

          # Bootstrap: Ensure kubernetes auth is enabled for vault-config-operator
          # vault-config-operator will manage the mount, but we need the role for bootstrap
          if vault auth list | grep -q "^kubernetes/"; then
            echo "Kubernetes auth already enabled"
            # Create controller-manager role for vault-config-operator bootstrap
            echo "Creating controller-manager kubernetes auth role..."
            vault write auth/kubernetes/role/controller-manager \
              bound_service_account_names=controller-manager,buildkit \
              bound_service_account_namespaces=vault-config-operator,buildkit \
              policies=vault-admin \
              ttl=24h
          else
            echo "Kubernetes auth will be enabled by vault-config-operator"
          fi

          echo "Vault admin setup complete"
