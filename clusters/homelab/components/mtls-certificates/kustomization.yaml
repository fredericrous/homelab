apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

# This component provides mTLS support for applications:
# 1. Syncs client CA certificate from Vault  
# 2. Creates patch job to add cacert to TLS secrets (which will be reflected by reflector)
#
# Required namespace annotation:
#   mtls/tls-secret-name: <tls-secret-name>
#
# Usage: The consuming kustomization must define a configMapGenerator:
# configMapGenerator:
# - name: mtls-config
#   literals:
#   - serviceAccount=<your-service-account>

resources:
  - client-ca-secret.yaml
  - patch-tls-job.yaml

# Patch the service account name from config
replacements:
- source:
    kind: ConfigMap
    name: mtls-config
    fieldPath: data.serviceAccount
  targets:
  - select:
      kind: Job
      name: patch-tls-cacert
    fieldPaths:
    - spec.template.spec.serviceAccountName