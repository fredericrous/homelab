---
apiVersion: batch/v1
kind: Job
metadata:
  name: stremio-web-build
  namespace: stremio
spec:
  ttlSecondsAfterFinished: 86400  # Keep job for 24 hours
  template:
    spec:
      serviceAccountName: stremio-build
      restartPolicy: Never
      initContainers:
      - name: wait-for-secret
        image: alpine/kubectl
        command: ['sh', '-c']
        args:
        - |
          echo "Waiting for gitea-admin secret to be available..."
          while ! kubectl get secret gitea-admin -n stremio >/dev/null 2>&1; do
            echo "Secret not found, waiting 5 seconds..."
            sleep 5
          done
          echo "✅ Secret gitea-admin is available, proceeding with build"
      containers:
      - name: build-stremio
        image: moby/buildkit:latest
        volumeMounts:
        - name: gitea-credentials
          mountPath: /var/secrets/gitea
          readOnly: true
        command:
        - sh
        - -c
        - |
          set -e
          
          # Install git and other dependencies
          apk add --no-cache git
          
          # Connect to cluster-wide BuildKit daemon
          export BUILDKIT_HOST=tcp://buildkitd.buildkit.svc.cluster.local:1234
          
          # Wait for BuildKit daemon to be ready
          while ! buildctl debug workers; do
            echo "Waiting for BuildKit daemon..."
            sleep 5
          done
          
          # Clone Stremio Web repository
          git clone https://github.com/Stremio/stremio-web.git /workspace
          cd /workspace
          
          # Get Gitea credentials
          GITEA_USERNAME=$(cat /var/secrets/gitea/username)
          GITEA_PASSWORD=$(cat /var/secrets/gitea/password)
          
          # Create Docker config for BuildKit authentication
          mkdir -p ~/.docker
          echo "{\"auths\":{\"gitea.gitea.svc.cluster.local:3000\":{\"auth\":\"$(echo -n $GITEA_USERNAME:$GITEA_PASSWORD | base64)\"}}}" > ~/.docker/config.json
          
          # Build and push the image with authentication
          buildctl build \
            --frontend dockerfile.v0 \
            --local context=. \
            --local dockerfile=. \
            --output type=image,name=gitea.gitea.svc.cluster.local:3000/admin/stremio-web:latest,push=true,registry.insecure=true,ocistore=false
          
          echo "✅ Stremio web image built and pushed successfully!"
      volumes:
      - name: gitea-credentials
        secret:
          secretName: gitea-admin