---
# PushSecret to dynamically migrate all cluster-vars from k8s to Vault KV2
# This bulk-migrates all bootstrap secrets to secret/data/cluster-vars
apiVersion: external-secrets.io/v1alpha1
kind: PushSecret
metadata:
  name: cluster-vars-to-vault
  namespace: flux-system
spec:
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  selector:
    secret:
      name: cluster-vars
  # PushSecret requires explicit data mapping (no dataFrom support)
  data:
    # Infrastructure networking
    - match:
        secretKey: ARGO_CLUSTER_DOMAIN
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: ARGO_CLUSTER_DOMAIN
    - match:
        secretKey: ARGO_CLUSTER_NAME
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: ARGO_CLUSTER_NAME
    - match:
        secretKey: ARGO_CONTROL_PLANE_IP
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: ARGO_CONTROL_PLANE_IP
    - match:
        secretKey: ARGO_EXTERNAL_DOMAIN
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: ARGO_EXTERNAL_DOMAIN
    - match:
        secretKey: ARGO_HAPROXY_MOBILE_IP
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: ARGO_HAPROXY_MOBILE_IP
    - match:
        secretKey: ARGO_HARBOR_IP
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: ARGO_HARBOR_IP
    - match:
        secretKey: ARGO_HARBOR_REGISTRY
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: ARGO_HARBOR_REGISTRY
    - match:
        secretKey: ARGO_HARBOR_REGISTRY_TLS
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: ARGO_HARBOR_REGISTRY_TLS
    - match:
        secretKey: ARGO_METALLB_POOL
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: ARGO_METALLB_POOL
    - match:
        secretKey: ARGO_MINIO_BROWSER_REDIRECT_URL
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: ARGO_MINIO_BROWSER_REDIRECT_URL
    - match:
        secretKey: ARGO_MINIO_QNAP_URL
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: ARGO_MINIO_QNAP_URL
    - match:
        secretKey: ARGO_MINIO_SERVER_URL
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: ARGO_MINIO_SERVER_URL
    - match:
        secretKey: ARGO_NAS_VAULT_ADDR
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: ARGO_NAS_VAULT_ADDR
    - match:
        secretKey: ARGO_QNAP_NAS_IP
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: ARGO_QNAP_NAS_IP
    - match:
        secretKey: ARGO_VAULT_API_ADDR
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: ARGO_VAULT_API_ADDR
    - match:
        secretKey: ARGO_VAULT_CLUSTER_ADDR
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: ARGO_VAULT_CLUSTER_ADDR
    - match:
        secretKey: CONTROL_PLANE_IP
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: CONTROL_PLANE_IP
    - match:
        secretKey: WORKER_1_IP
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: WORKER_1_IP
    - match:
        secretKey: WORKER_2_IP
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: WORKER_2_IP
    # OVH credentials
    - match:
        secretKey: CERT_MANAGER_OVH_APPLICATION_KEY
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: CERT_MANAGER_OVH_APPLICATION_KEY
    - match:
        secretKey: CERT_MANAGER_OVH_APPLICATION_SECRET
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: CERT_MANAGER_OVH_APPLICATION_SECRET
    - match:
        secretKey: CERT_MANAGER_OVH_CONSUMER_KEY
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: CERT_MANAGER_OVH_CONSUMER_KEY
    - match:
        secretKey: EXTERNAL_DNS_OVH_APPLICATION_KEY
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: EXTERNAL_DNS_OVH_APPLICATION_KEY
    - match:
        secretKey: EXTERNAL_DNS_OVH_APPLICATION_SECRET
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: EXTERNAL_DNS_OVH_APPLICATION_SECRET
    - match:
        secretKey: EXTERNAL_DNS_OVH_CONSUMER_KEY
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: EXTERNAL_DNS_OVH_CONSUMER_KEY
    # Application tokens
    - match:
        secretKey: FLUXCD_GITHUB_TOKEN
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: FLUXCD_GITHUB_TOKEN
    - match:
        secretKey: FLUXCD_OWNER
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: FLUXCD_OWNER
    - match:
        secretKey: FLUXCD_REPOSITORY
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: FLUXCD_REPOSITORY
    - match:
        secretKey: GHCR_TOKEN
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: GHCR_TOKEN
    - match:
        secretKey: GHCR_USERNAME
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: GHCR_USERNAME
    - match:
        secretKey: HUGGING_FACE_TOKEN
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: HUGGING_FACE_TOKEN
    - match:
        secretKey: PLEX_CLAIM_TOKEN
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: PLEX_CLAIM_TOKEN
    # Vault configuration
    - match:
        secretKey: QNAP_VAULT_ADDR
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: QNAP_VAULT_ADDR
    - match:
        secretKey: QNAP_VAULT_TOKEN
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: QNAP_VAULT_TOKEN
    - match:
        secretKey: VAULT_TRANSIT_TOKEN
        remoteRef:
          remoteKey: secret/data/cluster-vars
          property: VAULT_TRANSIT_TOKEN