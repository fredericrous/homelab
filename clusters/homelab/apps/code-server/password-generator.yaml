apiVersion: generators.external-secrets.io/v1alpha1
kind: Password
metadata:
  name: code-server-password
  namespace: code-server
spec:
  length: 32
  digits: 10
  symbols: 5
  symbolCharacters: "!@#$%^&*"
  noUpper: false
  allowRepeat: true

---
# Generate the actual Kubernetes secret from the password generator
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: code-server-password-generator
  namespace: code-server
spec:
  refreshInterval: "0s"  # Generate once
  secretStoreRef:
    kind: SecretStore
    name: vault-backend
  target:
    name: code-server-password
    creationPolicy: Owner
  dataFrom:
  - sourceRef:
      generatorRef:
        apiVersion: generators.external-secrets.io/v1alpha1
        kind: Password
        name: code-server-password

---
# Push the generated password to Vault for backup and compatibility
apiVersion: external-secrets.io/v1alpha1
kind: PushSecret
metadata:
  name: code-server-push-to-vault
  namespace: code-server
spec:
  refreshInterval: "1h"
  secretStoreRefs:
  - name: vault-backend
    kind: SecretStore
  selector:
    secret:
      name: code-server-password
  data:
  - match:
      secretKey: password
      remoteRef:
        remoteKey: secret/data/code-server
        property: password