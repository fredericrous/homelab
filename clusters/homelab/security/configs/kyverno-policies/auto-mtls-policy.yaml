apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: auto-generate-mtls-policy
  annotations:
    policies.kyverno.io/title: Auto-generate mTLS Policy for Service Gateways
    policies.kyverno.io/category: Security
    policies.kyverno.io/subject: ClientTrafficPolicy
    policies.kyverno.io/description: >-
      Automatically generates a ClientTrafficPolicy for mTLS when a Gateway is created.
spec:
  rules:
  - name: generate-mtls-policy
    match:
      any:
      - resources:
          kinds:
          - Gateway
          namespaces:
          - envoy-gateway-system
    exclude:
      any:
      - resources:
          annotations:
            "mtls.daddyshome.fr/skip": "true"
      - resources:
          names:
          - homelab-gateway
    generate:
      synchronize: true
      apiVersion: gateway.envoyproxy.io/v1alpha1
      kind: ClientTrafficPolicy
      name: "{{ request.object.metadata.name }}-mtls"
      namespace: envoy-gateway-system
      data:
        metadata:
          labels:
            app.kubernetes.io/managed-by: kyverno
            app.kubernetes.io/generated-from: "{{ request.object.metadata.name }}"
        spec:
          targetRef:
            group: gateway.networking.k8s.io
            kind: Gateway
            name: "{{ request.object.metadata.name }}"
          tls:
            clientValidation:
              optional: false
              caCertificateRefs:
              - name: mtls-ca-cert
                kind: Secret